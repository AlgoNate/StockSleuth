name: Stock Data Automation & Deploy

on:
  schedule:
    # 9:30 AM ET => 14:30 UTC
    - cron: "30 14 * * 1-5"
    # 1:00 PM ET => 18:00 UTC
    - cron: "0 18 * * 1-5"
    # 4:05 PM ET => 21:05 UTC
    - cron: "5 21 * * 1-5"
  workflow_dispatch:

jobs:
  stock_and_deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout repo
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Step 2: Setup Python
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # Step 3: Install Python dependencies
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # Step 4: Generate daily stock data and watchlist
      - name: Generate Stock Data
        run: |
          python collector/clean_and_collect.py
          python collector/generate_watchlist.py

      # Step 5: Setup Node
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      # Step 6: Install frontend dependencies
      - name: Install frontend packages
        run: |
          cd frontend
          npm install

      # Step 7: Build frontend with Parcel
      - name: Build frontend
        run: |
          cd frontend
          npm run build  # Ensure "build": "parcel build public/index.html --dist-dir dist" in package.json

      # Step 8: Copy JSON files into dist/datafiles
      - name: Copy JSON to frontend dist/datafiles
        run: |
          mkdir -p frontend/dist/datafiles
          cp collector/watchlist.json frontend/dist/datafiles/
          cp collector/daily_stock_data.json frontend/dist/datafiles/

      # Step 9: Ensure .nojekyll exists
      - name: Add .nojekyll
        run: touch frontend/dist/.nojekyll

      # Step 10: Deploy frontend to GitHub Pages
      - name: Deploy frontend
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./frontend/dist
          user_name: github-actions
          user_email: github-actions@github.com
          keep_files: true
          commit_message: "Deploy frontend + watchlist JSON [skip ci]"
          allow_empty_commit: true
          enable_jekyll: false
